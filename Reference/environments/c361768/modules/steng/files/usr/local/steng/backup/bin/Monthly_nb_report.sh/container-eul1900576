#!/bin/bash

############################################################
# Version: 1.1
# Created By: MS Storage Engineering - 2014/02/18
# Modified by: Sergi Pellis√© 2014/05/15
#
# Changelog: Changed the destionation emails to be inserted as parameter.
# V1.0 First review
# Usage: ./Monthly_nb_report.sh <Destination Addresses>
# Example: /usr/local/steng/backup/bin/Monthly_nb_report.sh ms.eng.storage@ntt.eu,adam.lembariti@ntt.eu
#
# Description: NetBackup script to analize the backup reports for last month (Full backup - non incremental) #
############################################################

EMAILS=$1
APPLI=/usr/openv/netbackup/bin/admincmd
LOG_GAT=/usr/openv/var/global/gath_reports
LOG_REP=/usr/openv/var/global/custom_reports
LOG_PATH=/usr/local/steng/backup/bin/logs
LOG_FILE=$LOG_PATH/gath_report`date "+%Y%m%d%H%M%S"`.log
LOG_FILE2=$LOG_PATH/cust_report`date "+%Y%m%d%H%M%S"`.log
LOG_RETAIN=90

### Check if exist the directory reports, if not we are going to create it:
        if [ ! -d $LOG_PATH ]; then
                mkdir $LOG_PATH
        fi
        if [ ! -d $LOG_GAT ]; then
                mkdir $LOG_GAT
        fi
        if [ ! -d $LOG_REP ]; then
                mkdir $LOG_REP
        fi

### Cleanup old log files:
        find $LOG_PATH -mtime +$LOG_RETAIN -exec rm {} \;

##########################################################
### GATHERING - collect NetBackup reports              ###
###             PHASE 1                                ###
##########################################################
        MONTH_AGO_INI=`date --date '1 month ago' "+%m/%d/%Y"`
        MONTH_AGO_END=`date --date '1 day  ago' "+%m/%d/%Y"`
        echo "Initial date: " $MONTH_AGO_INI
        echo "Ended date: " $MONTH_AGO_END

        echo "$APPLI/nbdeployutil --gather --start "$MONTH_AGO_INI 00:00:01" --end "$MONTH_AGO_END 23:59:59" --log=$LOG_FILE --output=$LOG_GAT"
        $APPLI/nbdeployutil --gather --start "$MONTH_AGO_INI 00:00:01" --end "$MONTH_AGO_END 23:59:59" --log=$LOG_FILE --output=$LOG_GAT

### To create a report for this master server, run the following:
### Get the report path:
        CMD=`cat $LOG_FILE | grep "nbdeployutil --report --capacity" | awk '{ print $NF }'`

        if [ -n $CMD ]
        then
                echo "$APPLI/nbdeployutil --report --capacity --start "$MONTH_AGO_INI 00:00:01" --end "$MONTH_AGO_END 23:59:59" $CMD --log=$LOG_FILE2 --output=$LOG_REP"
                $APPLI/nbdeployutil --report --capacity --start "$MONTH_AGO_INI 00:00:01" --end "$MONTH_AGO_END 23:59:59" $CMD --log=$LOG_FILE2 --output=$LOG_REP
                RC=$?
        else
                echo "\t Report could not be generated."
        fi

###   Report generated into the following location:
        XLS_FILE=`cat $LOG_FILE2 | grep "Report created at" | awk '{ print $NF }'`

### Prune custom_reports older than $LOG_RETAIN days:
        find $LOG_GAT -mtime +$LOG_RETAIN -exec rm -rf {} \;
        find $LOG_REP -name "*.xls" -mtime +$LOG_RETAIN -exec rm -rf {} \;

#####################################################
### SENDING REPORT VIA EMAIL                      ###
###     PHASE 2                                   ###
#####################################################
### Sending .XML report email ###
BODY_MESSAGE="Report message completed with RC: "$RC
SUBJECT=`hostname`": Monthly Netbackup capacity report"
SENDER=`hostname`@`hostname`.eu.verio.net

echo "Sending report: " $XLS_FILE
echo $BODY_MESSAGE | mailx -s "$SUBJECT" -r "$SENDER" -a $XLS_FILE $EMAILS
exit $?

