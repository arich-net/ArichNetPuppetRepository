# File generated by puppet
# LDAP Authentication
<%
service_name = scope.lookupvar('squid::params::service_name')
case service_name
	when 'squid':
-%>
auth_param basic program /usr/lib/squid/ldap_auth -v 3 -Z -D <%= scope.lookupvar('squid::params::ldap_auth_binddn') %> -w <%= scope.lookupvar('squid::params::ldap_auth_bindpwd') %> -h <%= scope.lookupvar('squid::params::ldap_auth_ldaphost') %> -p <%= scope.lookupvar('squid::params::ldap_auth_ldapport') %> -b "<%= scope.lookupvar('squid::params::ldap_auth_ldapbasedn') %>" -f "sAMAccountName=%s"
<%
	when 'squid3':
-%>
auth_param basic program /usr/lib/squid3/squid_ldap_auth -v 3 -Z -D <%= scope.lookupvar('squid::params::ldap_auth_binddn') %> -w <%= scope.lookupvar('squid::params::ldap_auth_bindpwd') %> -h <%= scope.lookupvar('squid::params::ldap_auth_ldaphost') %> -p <%= scope.lookupvar('squid::params::ldap_auth_ldapport') %> -b "<%= scope.lookupvar('squid::params::ldap_auth_ldapbasedn') %>" -f "sAMAccountName=%s"
<%
end
-%>                                                                                                                            
auth_param basic children 5
auth_param basic realm <%= scope.lookupvar('squid::params::ldap_auth_ldaprealm') %>
auth_param basic credentialsttl 1 minute

# LDAP Group Authorization
# LDAP GROUPS USING UNIX PARAMETERS
external_acl_type ldap_group %LOGIN /usr/lib/squid/squid_ldap_group -d -v 3 -ZZ -D <%= scope.lookupvar('squid::params::ldap_auth_binddn') %> -w <%= scope.lookupvar('squid::params::ldap_auth_bindpwd') %> -h <%= scope.lookupvar('squid::params::ldap_auth_ldaphost') %> -p <%= scope.lookupvar('squid::params::ldap_auth_ldapport') %> -b "<%= scope.lookupvar('squid::params::ldap_auth_ldapbasedn') %>" -f "(&(objectclass=person)(sAMAccountName=%v)(msSFU30PosixMemberOf=CN=%a,OU=NTT EO,DC=ntteng,DC=ntt,DC=eu))"

# ACL LDAP
acl ldap-auth proxy_auth REQUIRED

# ACL LDAP Group Authorization
<%
ldapgrouparray = scope.lookupvar('squid::params::ldap_auth_groups')
ldapgrouparray.sort_by {|key, value| key.to_i}.each do |key, value|
-%>
acl <%= value['groupname'] %> external ldap_group <%= value['ldapgroupname'] %>
<%
end
-%>